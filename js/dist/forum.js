(()=>{var t={n:e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},d:(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const o=flarum.core.compat["common/app"];t.n(o)().initializers.add("marchccc/flarum-ext-mentions-group-users",(function(){console.log("[marchccc/flarum-ext-mentions-group-users] Hello, forum and admin!")}));const r=flarum.core.compat["forum/app"];var n=t.n(r);const s=flarum.core.compat["common/extend"],a=flarum.core.compat["common/components/TextEditor"];var i=t.n(a);const c=flarum.core.compat["common/components/TextEditorButton"];var u=t.n(c);const p=flarum.core.compat["common/utils/KeyboardNavigatable"];var d=t.n(p);function l(t,e){return l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},l(t,e)}const f=flarum.core.compat["common/Fragment"];var h=function(t){var e,o;function r(){for(var e,o=arguments.length,r=new Array(o),n=0;n<o;n++)r[n]=arguments[n];return(e=t.call.apply(t,[this].concat(r))||this).items=[],e.active=!1,e.index=0,e.keyWasJustPressed=!1,e}o=t,(e=r).prototype=Object.create(o.prototype),e.prototype.constructor=e,l(e,o);var n=r.prototype;return n.view=function(){return m("ul",{className:"Dropdown-menu MentionsDropdown"},this.items.map((function(t){return m("li",null,t)})))},n.show=function(t,e){this.$().show().css({left:t+"px",top:e+"px"}),this.active=!0},n.hide=function(){this.$().hide(),this.active=!1},n.navigate=function(t){var e=this;this.keyWasJustPressed=!0,this.setIndex(this.index+t,!0),clearTimeout(this.keyWasJustPressedTimeout),this.keyWasJustPressedTimeout=setTimeout((function(){return e.keyWasJustPressed=!1}),500)},n.complete=function(){this.$("li").eq(this.index).find("button").click()},n.setIndex=function(t,e){if(!this.keyWasJustPressed||e){var o=this.$(),r=o.find("li"),n=t;n<0?n=r.length-1:n>=r.length&&(n=0),this.index=n;var s=r.removeClass("active").eq(n).addClass("active");if(e){var a,i=o.scrollTop(),c=o.offset().top,u=c+o.outerHeight(),m=s.offset().top,p=m+s.outerHeight();m<c?a=i-c+m-parseInt(o.css("padding-top"),10):p>u&&(a=i-u+p+parseInt(o.css("padding-bottom"),10)),void 0!==a&&o.stop(!0).animate({scrollTop:a},100)}}},r}(t.n(f)());const v=flarum.core.compat["common/helpers/username"];var g=t.n(v);const y=flarum.core.compat["common/helpers/highlight"];var x=t.n(y);const b=flarum.core.compat["common/helpers/avatar"];var w=t.n(b);const P=flarum.core.compat["common/utils/extractText"];var T=t.n(P),C=function(){return T()(n().translator.trans("core.lib.username.deleted_text"))};function _(){var t=$('<div class="ComposerBody-superMentionsDropdownContainer"></div>'),e=new h;(0,s.extend)(i().prototype,"oncreate",(function(){var o=this.$(".TextEditor-editor").wrap('<div class="ComposerBody-mentionsWrapper"></div>');this.navigator=new(d()),this.navigator.when((function(){return e.active})).onUp((function(){return e.navigate(-1)})).onDown((function(){return e.navigate(1)})).onSelect(e.complete.bind(e)).onCancel(e.hide.bind(e)).bindTo(o),o.after(t)})),(0,s.extend)(i().prototype,"buildEditorParams",(function(o){var r,s,a,i=this,c=Array.from([]),u=new Set(c.map((function(t){return t.id()})));n().store.find("group_users",{}).then((function(t){t.forEach((function(t){u.add(t.id()),c.push(t)}))})),o.inputListeners.push((function(){var o=i.attrs.composer.editor.getSelectionRange(),n=o[0];if(!(o[1]-n>0)){var u=i.attrs.composer.editor.getLastNChars(15);s=0;for(var p=u.length-1;p>=0;p--)if("/"===u.substr(p,1)&&(0==p||/\s/.test(u.substr(p-1,1)))){r=p+1,s=n-u.length+p+1;break}if(e.hide(),e.active=!1,s){a=u.substring(r).toLowerCase();!function(){var o=[];if(c.forEach((function(t){if(""==a||function(t){return[t.username(),t.displayName()].some((function(t){return t.toLowerCase().includes(a.toLowerCase())}))}(t)){var r=function(t,e){return void 0===e&&(e=!0),t?((e?t.displayName():t.username())||C()).replace(/"#[a-z]{0,3}[0-9]+/,"_"):C().replace(/"#[a-z]{0,3}[0-9]+/,"_")}(t,!1);o.push(function(t,o,r,n){void 0===n&&(n="");var c=g()(t);return a&&(c.children=[x()(c.text,a)],delete c.text),m("button",{className:"PostPreview "+n,onclick:function(){return function(t){i.attrs.composer.editor.replaceBeforeCursor(s-1,t+" "),e.hide()}(o)},onmouseenter:function(){e.setIndex($(this).parent().index())}},m("span",{className:"PostPreview-content"},w()(t),c))}(t,"@"+r,0,"MentionsDropdown-user"))}})),o.length){e.items=o,m.render(t[0],e.render()),e.show();var r=i.attrs.composer.editor.getCaretCoordinates(s),n=e.$().outerWidth(),u=e.$().outerHeight(),p=e.$().offsetParent(),d=r.left,l=r.top+15;l+u>p.height()&&(l=r.top-u-15),d+n>p.width()&&(d=p.width()-n),l=Math.max(-(p.offset().top-$(document).scrollTop()),l),d=Math.max(-p.offset().left,d),e.show(d,l)}else e.active=!1,e.hide()}(),e.setIndex(0),e.$().scrollTop(0),e.active=!0}}}))})),(0,s.extend)(i().prototype,"toolbarItems",(function(t){var e=this;t.add("superAt",m(u(),{onclick:function(){return e.attrs.composer.editor.insertAtCursor("/")},icon:"fas fa-user-plus"},n().translator.trans("marchccc-mentions-group-users.forum.composer.mention_tooltip")))}))}n().initializers.add("marchccc/flarum-ext-mentions-group-users",(function(){_()}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map