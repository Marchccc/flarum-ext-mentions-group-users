{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@marchccc/flarum-ext-mentions-group-users/webpack/bootstrap","webpack://@marchccc/flarum-ext-mentions-group-users/webpack/runtime/compat get default export","webpack://@marchccc/flarum-ext-mentions-group-users/webpack/runtime/define property getters","webpack://@marchccc/flarum-ext-mentions-group-users/webpack/runtime/hasOwnProperty shorthand","webpack://@marchccc/flarum-ext-mentions-group-users/webpack/runtime/make namespace object","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/app']\"","webpack://@marchccc/flarum-ext-mentions-group-users/./src/common/index.ts","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['forum/app']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/extend']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/components/TextEditor']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/components/TextEditorButton']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/utils/KeyboardNavigatable']\"","webpack://@marchccc/flarum-ext-mentions-group-users/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/Fragment']\"","webpack://@marchccc/flarum-ext-mentions-group-users/./src/forum/fragments/AutocompleteDropdown.js","webpack://@marchccc/flarum-ext-mentions-group-users/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/helpers/username']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/helpers/highlight']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/helpers/avatar']\"","webpack://@marchccc/flarum-ext-mentions-group-users/external root \"flarum.core.compat['common/utils/extractText']\"","webpack://@marchccc/flarum-ext-mentions-group-users/./src/forum/utils/getCleanDisplayName.js","webpack://@marchccc/flarum-ext-mentions-group-users/./src/forum/addComposerAutocomplete.js","webpack://@marchccc/flarum-ext-mentions-group-users/./src/forum/index.js"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/app'];","import app from 'flarum/common/app';\n\napp.initializers.add('marchccc/flarum-ext-mentions-group-users', () => {\n  console.log('[marchccc/flarum-ext-mentions-group-users] Hello, forum and admin!');\n});\n","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/TextEditor'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/TextEditorButton'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/KeyboardNavigatable'];","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/Fragment'];","import Fragment from 'flarum/common/Fragment';\n\nexport default class AutocompleteDropdown extends Fragment {\n  items = [];\n  active = false;\n  index = 0;\n  keyWasJustPressed = false;\n\n  view() {\n    return (\n      <ul className=\"Dropdown-menu MentionsDropdown\">\n        {this.items.map((item) => (\n          <li>{item}</li>\n        ))}\n      </ul>\n    );\n  }\n\n  show(left, top) {\n    this.$()\n      .show()\n      .css({\n        left: left + 'px',\n        top: top + 'px',\n      });\n    this.active = true;\n  }\n\n  hide() {\n    this.$().hide();\n    this.active = false;\n  }\n\n  navigate(delta) {\n    this.keyWasJustPressed = true;\n    this.setIndex(this.index + delta, true);\n    clearTimeout(this.keyWasJustPressedTimeout);\n    this.keyWasJustPressedTimeout = setTimeout(() => (this.keyWasJustPressed = false), 500);\n  }\n\n  complete() {\n    this.$('li').eq(this.index).find('button').click();\n  }\n\n  setIndex(index, scrollToItem) {\n    if (this.keyWasJustPressed && !scrollToItem) return;\n\n    const $dropdown = this.$();\n    const $items = $dropdown.find('li');\n    let rangedIndex = index;\n\n    if (rangedIndex < 0) {\n      rangedIndex = $items.length - 1;\n    } else if (rangedIndex >= $items.length) {\n      rangedIndex = 0;\n    }\n\n    this.index = rangedIndex;\n\n    const $item = $items.removeClass('active').eq(rangedIndex).addClass('active');\n\n    if (scrollToItem) {\n      const dropdownScroll = $dropdown.scrollTop();\n      const dropdownTop = $dropdown.offset().top;\n      const dropdownBottom = dropdownTop + $dropdown.outerHeight();\n      const itemTop = $item.offset().top;\n      const itemBottom = itemTop + $item.outerHeight();\n\n      let scrollTop;\n      if (itemTop < dropdownTop) {\n        scrollTop = dropdownScroll - dropdownTop + itemTop - parseInt($dropdown.css('padding-top'), 10);\n      } else if (itemBottom > dropdownBottom) {\n        scrollTop = dropdownScroll - dropdownBottom + itemBottom + parseInt($dropdown.css('padding-bottom'), 10);\n      }\n\n      if (typeof scrollTop !== 'undefined') {\n        $dropdown.stop(true).animate({ scrollTop }, 100);\n      }\n    }\n  }\n}\n","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/username'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/highlight'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/helpers/avatar'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/extractText'];","import app from 'flarum/forum/app';\nimport extractText from 'flarum/common/utils/extractText';\n\n/**\n * Whether to use the old mentions format.\n *\n * `'@username'` or `'@\"Display name\"'`\n */\nexport const shouldUseOldFormat = () => app.forum.attribute('allowUsernameMentionFormat') || false;\n\nconst getDeletedUserText = () => extractText(app.translator.trans('core.lib.username.deleted_text'));\n\n/**\n * Fetches a user's username or display name.\n *\n * Chooses based on the format option set in the admin settings page.\n *\n * @param user An instance of the User model to fetch the username for\n * @param useDisplayName If `true`, uses `user.displayName()`, otherwise, uses `user.username()`\n */\nexport default function getCleanDisplayName(user, useDisplayName = true) {\n  if (!user) return getDeletedUserText().replace(/\"#[a-z]{0,3}[0-9]+/, '_');\n\n  const text = (useDisplayName ? user.displayName() : user.username()) || getDeletedUserText();\n\n  return text.replace(/\"#[a-z]{0,3}[0-9]+/, '_');\n}\n","import app from 'flarum/forum/app';\nimport { extend } from 'flarum/common/extend';\nimport TextEditor from 'flarum/common/components/TextEditor';\nimport TextEditorButton from 'flarum/common/components/TextEditorButton';\nimport KeyboardNavigatable from 'flarum/common/utils/KeyboardNavigatable';\nimport AutocompleteDropdown from './fragments/AutocompleteDropdown';\nimport usernameHelper from 'flarum/common/helpers/username';\nimport highlight from 'flarum/common/helpers/highlight';\nimport avatar from 'flarum/common/helpers/avatar';\nimport getCleanDisplayName from './utils/getCleanDisplayName';\n\nexport default function addComposerAutocomplete() {\n\n  const $container = $('<div class=\"ComposerBody-superMentionsDropdownContainer\"></div>');\n  const dropdown = new AutocompleteDropdown();\n\n  extend(TextEditor.prototype, 'oncreate', function () {\n    const $editor = this.$('.TextEditor-editor').wrap('<div class=\"ComposerBody-mentionsWrapper\"></div>');\n\n    // 绑定键盘动作回调给下拉列表类\n    this.navigator = new KeyboardNavigatable();\n    this.navigator\n      .when(() => dropdown.active)\n      .onUp(() => dropdown.navigate(-1))\n      .onDown(() => dropdown.navigate(1))\n      .onSelect(dropdown.complete.bind(dropdown))\n      .onCancel(dropdown.hide.bind(dropdown))\n      .bindTo($editor);\n\n    $editor.after($container);\n  });\n\n  extend(TextEditor.prototype, 'buildEditorParams', function (params) {\n    let relMentionStart;\n    let absMentionStart;\n    let typed;\n\n    const returnedUsers = Array.from([]);\n    const returnedUserIds = new Set(returnedUsers.map((u) => u.id()));\n\n    app.store.find('group_users', {}).then((results) => {\n      results.forEach((u) => {\n        returnedUserIds.add(u.id());\n        returnedUsers.push(u);\n      });\n    });\n\n    // 选中\n    const applySuggestion = (replacement) => {\n      this.attrs.composer.editor.replaceBeforeCursor(absMentionStart - 1, replacement + ' ');\n\n      dropdown.hide();\n    };\n\n    // 增加输入监听事件\n    params.inputListeners.push(() => {\n      const selection = this.attrs.composer.editor.getSelectionRange();\n\n      const cursor = selection[0];\n\n      if (selection[1] - cursor > 0) return;\n\n      // 从光标向后搜索 '/', 显示自动完成下拉\n      const lastChunk = this.attrs.composer.editor.getLastNChars(15);\n      absMentionStart = 0;\n      for (let i = lastChunk.length - 1; i >= 0; i--) {\n        const character = lastChunk.substr(i, 1);\n        // 确保 '/' 前面有空格或换行符\n        if (character === '/' && (i == 0 || /\\s/.test(lastChunk.substr(i - 1, 1)))) {\n          relMentionStart = i + 1;\n          absMentionStart = cursor - lastChunk.length + i + 1;\n          break;\n        }\n      }\n\n      dropdown.hide();\n      dropdown.active = false;\n\n      if (absMentionStart) {\n        // 输入内容\n        typed = lastChunk.substring(relMentionStart).toLowerCase();\n\n        // 生成显示列表的单个项\n        const makeSuggestion = function (user, replacement, content, className = '') {\n          const username = usernameHelper(user);\n\n          if (typed) {\n            username.children = [highlight(username.text, typed)];\n            delete username.text;\n          }\n\n          return (\n            <button\n              className={'PostPreview ' + className}\n              onclick={() => applySuggestion(replacement)}\n              onmouseenter={function () {\n                dropdown.setIndex($(this).parent().index());\n              }}\n            >\n              <span className=\"PostPreview-content\">\n                {avatar(user)}\n                {username}\n              </span>\n            </button>\n          );\n        };\n\n        // 根据关键字匹配\n        const userMatches = function (user) {\n          const names = [user.username(), user.displayName()];\n\n          return names.some((name) => name.toLowerCase().includes(typed.toLowerCase()));\n        };\n\n        // 生成显示列表\n        const buildSuggestions = () => {\n          const suggestions = [];\n\n          returnedUsers.forEach((user) => {\n\n            // 如果输入了关键字则过滤显示列表\n            if (typed != '') {\n              if (!userMatches(user)) return;\n            }\n\n            const cleanText = getCleanDisplayName(user, false);\n\n            suggestions.push(makeSuggestion(user, `@${cleanText}`, '', 'MentionsDropdown-user'));\n          });\n\n\n          if (suggestions.length) {\n            dropdown.items = suggestions;\n            m.render($container[0], dropdown.render());\n\n            dropdown.show();\n            const coordinates = this.attrs.composer.editor.getCaretCoordinates(absMentionStart);\n            const width = dropdown.$().outerWidth();\n            const height = dropdown.$().outerHeight();\n            const parent = dropdown.$().offsetParent();\n            let left = coordinates.left;\n            let top = coordinates.top + 15;\n\n            // 将下拉列表保留在编辑器中\n            if (top + height > parent.height()) {\n              top = coordinates.top - height - 15;\n            }\n            if (left + width > parent.width()) {\n              left = parent.width() - width;\n            }\n\n            // 防止手机上的下拉列表离开屏幕\n            top = Math.max(-(parent.offset().top - $(document).scrollTop()), top);\n            left = Math.max(-parent.offset().left, left);\n\n            dropdown.show(left, top);\n          } else {\n            dropdown.active = false;\n            dropdown.hide();\n          }\n        };\n\n        buildSuggestions();\n\n        dropdown.setIndex(0);\n        dropdown.$().scrollTop(0);\n        dropdown.active = true;\n      }\n    });\n  });\n\n  extend(TextEditor.prototype, 'toolbarItems', function (items) {\n    items.add(\n      'superAt',\n      <TextEditorButton onclick={() => this.attrs.composer.editor.insertAtCursor('/')} icon=\"fas fa-user-plus\">\n        {app.translator.trans('marchccc-mentions-group-users.forum.composer.mention_tooltip')}\n      </TextEditorButton>\n    );\n  });\n}\n","import app from 'flarum/forum/app';\nimport addComposerAutocomplete from './addComposerAutocomplete';\n\napp.initializers.add('marchccc/flarum-ext-mentions-group-users', function () {\n\n\n  // 在输入 ',' 后，展示一个下拉列表可以选择要@的用户\n  addComposerAutocomplete();\n  \n});"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","flarum","core","compat","app","console","log","_setPrototypeOf","p","setPrototypeOf","bind","__proto__","AutocompleteDropdown","_Fragment","subClass","superClass","_this","_len","arguments","length","args","Array","_key","apply","concat","items","active","index","keyWasJustPressed","create","constructor","_proto","view","m","className","this","map","item","show","left","top","$","css","hide","navigate","delta","_this2","setIndex","clearTimeout","keyWasJustPressedTimeout","setTimeout","complete","eq","find","click","scrollToItem","$dropdown","$items","rangedIndex","$item","removeClass","addClass","scrollTop","dropdownScroll","dropdownTop","offset","dropdownBottom","outerHeight","itemTop","itemBottom","parseInt","stop","animate","Fragment","getDeletedUserText","extractText","addComposerAutocomplete","$container","dropdown","extend","TextEditor","$editor","wrap","navigator","KeyboardNavigatable","when","onUp","onDown","onSelect","onCancel","bindTo","after","params","relMentionStart","absMentionStart","typed","returnedUsers","from","returnedUserIds","Set","u","id","then","results","forEach","add","push","inputListeners","selection","attrs","composer","editor","getSelectionRange","cursor","lastChunk","getLastNChars","i","substr","test","substring","toLowerCase","suggestions","user","username","displayName","some","name","includes","userMatches","cleanText","useDisplayName","replace","getCleanDisplayName","replacement","content","usernameHelper","children","highlight","text","onclick","replaceBeforeCursor","applySuggestion","onmouseenter","parent","avatar","makeSuggestion","render","coordinates","getCaretCoordinates","width","outerWidth","height","offsetParent","Math","max","document","buildSuggestions","TextEditorButton","insertAtCursor","icon"],"sourceRoot":""}